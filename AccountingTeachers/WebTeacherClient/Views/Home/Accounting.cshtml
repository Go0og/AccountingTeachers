@{
    ViewData["Title"] = "Accounting";
}

<div class="text-center">
    <h2 class="display-4">Учетность</h2>
</div>

<div class="filters-container mb-3">
    <div class="row">
        <div class="col-md-2">
            <input type="text" class="form-control filter-input" data-column="0" placeholder="Фильтр по кафедре">
        </div>
        <div class="col-md-2">
            <input type="text" class="form-control filter-input" data-column="1" placeholder="Фильтр по ФИО">
        </div>
        <div class="col-md-2">
            <input type="text" class="form-control filter-input" data-column="2" placeholder="Фильтр по должности">
        </div>
        <div class="col-md-2">
            <input type="text" class="form-control filter-input" data-column="3" placeholder="Фильтр по званию">
        </div>
        <div class="col-md-2">
            <input type="text" class="form-control filter-input" data-column="4" placeholder="Фильтр по ставке">
        </div>
        <div class="col-md-2">
            <button id="resetFilters" class="btn btn-secondary">Сбросить фильтры</button>
        </div>
    </div>
</div>
<div class="card-header d-flex justify-content-between align-items-center">
    <h4>Текущий контроль </h4>
    <button id="downloadReport" class="btn btn-success">Скачать</button>
</div>
<table id="accountingTable" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Кафедра</th>
            <th>ФИО</th>
            <th>Должность</th>
            <th>Звание</th>
            <th>Ставка</th>
            <th>Действия</th> <!-- Добавили колонку для кнопки -->
        </tr>
    </thead>
    <tbody>
        <!-- Данные будут загружены через AJAX -->
    </tbody>
</table>

<!-- Модальное окно (добавляем в КОНЕЦ файла Accounting.cshtml) -->
<div class="modal fade" id="teacherCardModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Карточка преподавателя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">ФИО:</div>
                    <div class="col-md-8" id="card-fio"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Кафедра:</div>
                    <div class="col-md-8" id="card-department"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Должность:</div>
                    <div class="col-md-8" id="card-position"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Звание:</div>
                    <div class="col-md-8" id="card-title"></div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4 fw-bold">Ставка:</div>
                    <div class="col-md-8" id="card-bet"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Подключаем Bootstrap JS (ОБЯЗАТЕЛЬНО!) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"></script>

    <script>
        // Объявляем переменную table в глобальной области видимости
        var table;

        $(document).ready(function() {
            table = $('#accountingTable').DataTable({
                ajax: {
                    url: '@Url.Action("GetAllAccountingData", "Home")',
                    type: 'GET',
                    dataSrc: function(json) {
                        console.log("Полученные данные:", json);
                        return json;
                    }
                },
                columns: [
                    { data: 'departmentName' },
                    { data: 'fio' },
                    { data: 'position' },
                    { data: 'title' },
                    { data: 'bet' },
                    {
                        data: null,
                        render: function(data, type, row) {
                            return '<button class="btn btn-sm btn-primary teacher-card-btn" data-teacher=\'' + JSON.stringify(row) + '\'>Карточка</button>';
                        },
                        orderable: false,
                        width: "120px"
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.11.5/i18n/ru.json'
                }
            });

            // Фильтры
            $('.filter-input').on('keyup change', function() {
                var columnIndex = $(this).data('column');
                table.column(columnIndex).search($(this).val()).draw();
            });

            $('#resetFilters').on('click', function() {
                $('.filter-input').val('');
                table.search('').columns().search('').draw();
            });

            // Обработчик кнопки карточки
            $(document).on('click', '.teacher-card-btn', function() {
                var teacherData = JSON.parse($(this).attr('data-teacher'));

                $('#card-fio').text(teacherData.fio || 'Не указано');
                $('#card-department').text(teacherData.departmentName || 'Не указано');
                $('#card-position').text(teacherData.position || 'Не указано');
                $('#card-title').text(teacherData.title || 'Не указано');
                $('#card-bet').text(teacherData.bet || 'Не указано');

                var modal = new bootstrap.Modal(document.getElementById('teacherCardModal'));
                modal.show();
            });

            // Обработчик кнопки скачивания
                   $('#downloadReport').on('click', function() {
            // Получаем ВСЕ данные таблицы (с учетом фильтров)
            var allData = table.rows({ search: 'applied' }).data().toArray();

            // Проверяем есть ли данные
            if (allData.length === 0) {
                alert('Нет данных для экспорта!');
                return;
            }

            // Показываем загрузку
            $(this).html('<span class="spinner-border spinner-border-sm"></span> Генерация...');

            // Кодируем данные в base64 для передачи в URL
            var dataStr = btoa(unescape(encodeURIComponent(JSON.stringify(allData))));

            // Формируем URL с параметром
            var url = '@Url.Action("generateWordReportAccounting", "Home")?data=' + encodeURIComponent(dataStr);

            // Создаем временную ссылку для скачивания
            var link = document.createElement('a');
            link.href = url;
            link.download = 'Отчет_учетность.docx';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Восстанавливаем кнопку
            setTimeout(() => {
                $('#downloadReport').html('Скачать');
            }, 1000);
        });
        });
    </script>
}